<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Prédictions - EcoSense</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand"><i class="fas fa-leaf"></i> EcoSense</div>
        <ul class="nav-menu">
            <li><a href="{{ url_for('home') }}"><i class="fas fa-home"></i> Accueil</a></li>
            <li><a href="{{ url_for('equipments') }}"><i class="fas fa-plug"></i> Équipements</a></li>
            <li><a href="{{ url_for('add_usage') }}"><i class="fas fa-plus-circle"></i> Ajouter</a></li>
            <li><a href="{{ url_for('statistics') }}"><i class="fas fa-chart-bar"></i> Stats</a></li>
            <li><a href="{{ url_for('comparisons') }}"><i class="fas fa-balance-scale"></i> Comparaisons</a></li>
            <li><a href="{{ url_for('settings') }}"><i class="fas fa-cog"></i> Paramètres</a></li>
            {% if session.is_admin == 1 %}
            <li><a href="{{ url_for('admin_panel') }}"><i class="fas fa-shield-alt"></i> Admin</a></li>
            {% endif %}
            <li><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Quitter</a></li>
        </ul>
        <div class="nav-user">
            <a href="{{ url_for('profile') }}" style="color: inherit; text-decoration: none;">
                <i class="fas fa-user-circle"></i> {{ session.username }}
            </a>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-crystal-ball"></i> Prédictions</h1>
            <a href="{{ url_for('statistics') }}" class="btn btn-secondary">Retour aux stats</a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if predictions %}
        <div class="section">
            <h2><i class="fas fa-chart-line"></i> Prédiction des 7 prochains jours</h2>
            <p>Basé sur vos habitudes de consommation des 30 derniers jours (régression linéaire).</p>
            <canvas id="predictionChart"></canvas>
        </div>

        <div class="section">
            <h2><i class="fas fa-table"></i> Détails des prédictions</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Jour</th>
                        <th>Consommation prévue (kWh)</th>
                        <th>Coût estimé (FCFA)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pred in predictions %}
                    <tr>
                        <td>{{ pred.date }}</td>
                        <td>{{ pred.day_name }}</td>
                        <td><strong>{{ pred.prediction }} kWh</strong></td>
                        <td>{{ (pred.prediction * 150)|round|int }} FCFA</td>
                    </tr>
                    {% endfor %}
                    <tr style="background: #f8f9fa; font-weight: bold;">
                        <td colspan="2">TOTAL SEMAINE</td>
                        <td>{{ predictions | sum(attribute='prediction') | round(2) }} kWh</td>
                        <td>{{ (predictions | sum(attribute='prediction') * 150) | round | int }} FCFA</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="info-box">
            <strong><i class="fas fa-info-circle"></i> À propos des prédictions :</strong>
            <p>Ces prédictions sont basées sur un modèle de régression linéaire qui analyse vos 30 derniers jours de consommation. Elles sont indicatives et peuvent varier selon vos habitudes réelles.</p>
        </div>
        {% endif %}
    </div>

    {% if predictions %}
    <script>
        const ctx = document.getElementById('predictionChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ predictions | map(attribute='day_name') | list | tojson }},
                datasets: [{
                    label: 'Prédiction (kWh)',
                    data: {{ predictions | map(attribute='prediction') | list | tojson }},
                    backgroundColor: 'rgba(155, 89, 182, 0.2)',
                    borderColor: '#9b59b6',
                    borderWidth: 3,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
    {% endif %}
</body>
</html>