<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Statistiques - EcoSense</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand"><i class="fas fa-leaf"></i> EcoSense</div>
        <ul class="nav-menu">
            <li><a href="{{ url_for('home') }}"><i class="fas fa-home"></i> Accueil</a></li>
            <li><a href="{{ url_for('equipments') }}"><i class="fas fa-plug"></i> Équipements</a></li>
            <li><a href="{{ url_for('add_usage') }}"><i class="fas fa-plus-circle"></i> Ajouter</a></li>
            <li><a href="{{ url_for('statistics') }}" class="active"><i class="fas fa-chart-bar"></i> Stats</a></li>
            <li><a href="{{ url_for('comparisons') }}"><i class="fas fa-balance-scale"></i> Comparaisons</a></li>
            <li><a href="{{ url_for('settings') }}"><i class="fas fa-cog"></i> Paramètres</a></li>
            {% if session.is_admin == 1 %}
            <li><a href="{{ url_for('admin_panel') }}"><i class="fas fa-shield-alt"></i> Admin</a></li>
            {% endif %}
            <li><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Quitter</a></li>
        </ul>
        <div class="nav-user">
            <a href="{{ url_for('profile') }}" style="color: inherit; text-decoration: none;">
                <i class="fas fa-user-circle"></i> {{ session.username }}
            </a>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>Statistiques</h1>
            <a href="{{ url_for('predictions') }}" class="btn btn-primary">
                <i class="fas fa-crystal-ball"></i> Voir les prédictions
            </a>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clipboard-list" style="color: #3498db;"></i>
                </div>
                <div class="stat-content">
                    <h3>Total utilisations</h3>
                    <p class="stat-value">{{ total_usages }}</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-bolt" style="color: #f39c12;"></i>
                </div>
                <div class="stat-content">
                    <h3>Consommation totale</h3>
                    <p class="stat-value">{{ total_consommation }} kWh</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-money-bill-wave" style="color: #2ecc71;"></i>
                </div>
                <div class="stat-content">
                    <h3>Coût total estimé</h3>
                    <p class="stat-value">{{ (total_consommation * 150)|round|int }} FCFA</p>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-content">
                    <h3>Cette semaine</h3>
                    <p class="stat-value">{{ week_total }} kWh</p>
                    <small>{{ (week_total * 150)|round|int }} FCFA</small>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-content">
                    <h3>Ce mois</h3>
                    <p class="stat-value">{{ month_total }} kWh</p>
                    <small>{{ (month_total * 150)|round|int }} FCFA</small>
                </div>
            </div>
        </div>

        <!-- Graphique : Semaine -->
        <div class="section">
            <h2><i class="fas fa-chart-line"></i> Consommation des 7 derniers jours</h2>
            <canvas id="weeklyChart"></canvas>
        </div>

        <!-- Graphique : Équipements -->
        <div class="section">
            <h2><i class="fas fa-chart-pie"></i> Répartition par équipement</h2>
            <canvas id="equipmentChart"></canvas>
        </div>
    </div>

    <script>
        // Graphique semaine
        const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
        new Chart(weeklyCtx, {
            type: 'bar',
            data: {
                labels: {{ weekly_data | map(attribute='day_name') | list | tojson }},
                datasets: [{
                    label: 'Consommation (kWh)',
                    data: {{ weekly_data | map(attribute='consommation') | list | tojson }},
                    backgroundColor: '#2ecc71',
                    borderColor: '#27ae60',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Graphique équipements
        const equipmentCtx = document.getElementById('equipmentChart').getContext('2d');
        new Chart(equipmentCtx, {
            type: 'doughnut',
            data: {
                labels: {{ equipment_data | map(attribute='name') | list | tojson }},
                datasets: [{
                    data: {{ equipment_data | map(attribute='consommation') | list | tojson }},
                    backgroundColor: [
                        '#3498db', '#e74c3c', '#f39c12', '#9b59b6',
                        '#1abc9c', '#34495e', '#e67e22', '#95a5a6',
                        '#16a085', '#c0392b'
                    ]
                }]
            },
            options: {
                responsive: true
            }
        });
    </script>
</body>
</html>